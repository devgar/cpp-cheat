#!/usr/bin/env bash
set -eu
nfiles="${1:-10}"
nsyms="${2:-10}"
cflags='-ggdb3 -O0 -std=c99 -Wall -Wextra -pedantic'
cat <<EOF >main.c
#include "main.h"

int main(void) {
  return
EOF
rm -f main.h
file=0
while [ "$file" -lt "$nfiles" ]; do
  sym_i=0
  rm -f "${file}.c"
  while [ "$sym_i" -lt "$nsyms" ]; do
    echo "${file} ${sym_i}"
    sym="i_${file}_${sym_i}"
    echo "unsigned int ${sym} = ${file};" >> "${file}.c"
    echo "extern unsigned int ${sym};" >> main.h
    echo "${sym} +" >> main.c
    sym_i=$((sym_i + 1))
  done
  file=$((file + 1))
done
cat <<EOF >>main.c
  1;
}
EOF
ls | grep -E '\.c$' | parallel -t --will-cite "gcc $cflags -c -o '{.}.o' '{}'"
echo
/usr/bin/time -v gcc $cflags -o main *.o
echo
/usr/bin/time -v gcc $cflags -fuse-ld=gold -o main *.o
